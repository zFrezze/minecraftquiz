<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Quizduell Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap">
  <style>
    :root {
      --primary: #a855ff;
      --primary-soft: #7c3aed;
      --primary-dark: #4c1d95;
      --text-main: #f9fafb;
      --text-dim: #9ca3af;
      --danger: #f97373;
      --radius-pill: 999px;
      --radius-lg: 1.4rem;
      --shadow-strong: 0 22px 48px rgba(0,0,0,0.9);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      position: relative;
      overflow-x: hidden;
      background: #020617;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 50% 40%,
          #2b2b33 0%,
          #111827 45%,
          #020617 80%,
          #000000 100%
        );
      z-index: -2;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        linear-gradient(#3f3f46 1px, transparent 1px),
        linear-gradient(90deg, #3f3f46 1px, transparent 1px);
      background-size: 120px 120px;
      opacity: 0.22;
      mix-blend-mode: screen;
      z-index: -1;
    }

    .app-shell {
      width: 100%;
      max-width: 1500px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* HEADER */

    .top-header {
      position: relative;
      padding: 20px 20px 32px;
    }

    .logo-centered {
      display: flex;
      justify-content: center;
    }

    .logo-badge {
      position: relative;
      padding: 20px 54px 30px;
      border-radius: 40px;
      background: #7c3aed;
      box-shadow:
        0 18px 40px rgba(0,0,0,0.9),
        0 0 0 4px #000,
        0 0 0 7px #facc15;
      display: inline-flex;
      align-items: flex-end;
      gap: 14px;
    }

    .logo-badge::after {
      content: "";
      position: absolute;
      bottom: -20px;
      left: 46px;
      width: 30px;
      height: 22px;
      background: #7c3aed;
      border-radius: 0 0 24px 24px;
      transform: skewX(-18deg);
      box-shadow: 0 18px 40px rgba(0,0,0,1);
    }

    .logo-main {
      font-size: 3.4rem;
      line-height: 1;
      font-weight: 900;
      letter-spacing: 0.08em;
      color: #facc15;
      text-shadow:
        -3px 3px 0 #000,
        0 0 24px rgba(250,204,21,0.95);
    }

    .logo-question {
      font-size: 2.8rem;
      line-height: 1;
      font-weight: 900;
      color: #facc15;
      text-shadow:
        -3px 3px 0 #000,
        0 0 18px rgba(250,204,21,0.95);
    }

    .turn-overlay {
      position: absolute;
      right: 32px;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: #a855ff;
      text-shadow: 0 0 14px rgba(168,85,255,0.9);
    }

    .turn-player {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(168,85,255,0.7);
      box-shadow: 0 12px 28px rgba(0,0,0,1);
    }

    .turn-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(to top, #020617, var(--primary-dark), var(--primary-soft));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 800;
      color: #f9fafb;
      box-shadow: 0 12px 28px rgba(0,0,0,1);
    }

    .turn-label {
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .phase-badge {
      position: absolute;
      left: 32px;
      bottom: 6px;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    @media (max-width: 768px) {
      .turn-overlay {
        right: 16px;
        top: auto;
        bottom: 6px;
        transform: none;
      }
      .phase-badge {
        left: 16px;
      }
    }

    /* BOARD */

    .board-wrapper {
      flex: 1;
      padding: 10px 0 8px;
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .board-inner {
      padding: 0;
    }

    .board {
      display: grid;
      gap: 10px 18px;
      margin-inline: auto;
      max-width: 1400px;
    }

    .board.dynamic-cols-6 { grid-template-columns: repeat(6, minmax(0,1fr)); }
    .board.dynamic-cols-custom { grid-template-columns: repeat(var(--col-count), minmax(0,1fr)); }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-inline: 8px;
      user-select: none;
    }

    .cell.category { height: 70px; }

    .pill {
      width: 100%;
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 10px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.9);
    }

    .pill::before {
      content: "";
      position: absolute;
      inset: -60%;
      background: radial-gradient(circle at top, rgba(255,255,255,0.18), transparent 60%);
      opacity: 0.75;
      pointer-events: none;
    }

    .pill.category-pill {
      background: linear-gradient(to top, #020617 0%, var(--primary-dark) 50%, var(--primary-soft) 100%);
      border: 2px solid #ffffff;
    }

    .pill.value-pill {
      background: linear-gradient(to top, #020617 0%, #2b1563 50%, #6d28d9 100%);
      border: 2px solid #6b7280;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
                  filter 0.12s ease, border-color 0.15s ease, opacity 0.15s ease;
    }

    .pill.value-pill:hover {
      transform: translateY(-3px);
      box-shadow: 0 22px 50px rgba(0,0,0,1);
      border-color: #9ca3af;
      filter: brightness(1.08);
    }

    .pill.value-pill:active {
      transform: translateY(1px);
      box-shadow: 0 10px 22px rgba(0,0,0,1);
    }

    .pill.value-pill.used {
      cursor: default;
      opacity: 0.22;
      filter: grayscale(0.4);
      box-shadow: none;
      border-color: #4b5563;
    }

    .category-label {
      font-size: 0.9rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 700;
      color: #f9fafb;
      padding-inline: 6px;
      text-shadow: 0 0 14px rgba(255,255,255,0.5);
    }

    .value-label {
      font-size: 1.25rem;
      font-weight: 900;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .board-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 0.82rem;
      color: var(--text-dim);
      padding-inline: 4px;
    }

    .footer-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.12s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
    }

    button.primary {
      background: linear-gradient(to top, #020617, var(--primary-dark), var(--primary-soft));
      color: #f9fafb;
    }

    button.danger {
      background: linear-gradient(to top, #b91c1c, #f97373);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0,0,0,1);
      background: rgba(31,41,55,0.95);
    }

    button.primary:hover {
      background: linear-gradient(to top, #020617, #8b5cf6, #4c1d95);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(0,0,0,1);
    }

    /* TEAMS */

    .teams-bar {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
    }

    .team-card {
      background: radial-gradient(circle at top, #111827, #020617 80%);
      border-radius: 20px;
      border: 2px solid rgba(148,163,184,0.6);
      padding: 14px 12px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 20px 42px rgba(0,0,0,1);
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
    }

    .team-card.active {
      border-color: #22c55e;
      box-shadow: 0 0 24px rgba(34,197,94,0.7);
      transform: translateY(-2px);
    }

    .team-card.buzzing {
      border-color: #f97373;
      box-shadow: 0 0 24px rgba(248,113,113,0.9);
    }

    .team-avatars {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .team-avatar {
      width: 50px;
      height: 50px;
      border-radius: 999px;
      background: linear-gradient(to top, #020617, var(--primary-dark), var(--primary-soft));
      border: 3px solid rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 800;
      text-transform: uppercase;
      box-shadow: 0 12px 26px rgba(0,0,0,1);
      background-size: cover;
      background-position: center;
      color: #f9fafb;
    }

    .team-title {
      font-size: 0.8rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .team-names {
      margin-top: 2px;
      font-size: 0.9rem;
    }

    .team-score {
      margin-top: 6px;
      font-size: 1.35rem;
      font-weight: 800;
      color: #fef08a;
      text-shadow: 0 0 12px rgba(254,240,138,0.8);
    }

    .team-score-caption {
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-top: 1px;
    }

    @media (max-width: 1100px) {
      .board { transform: scale(0.95); transform-origin: top center; }
      .teams-bar { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    @media (max-width: 768px) {
      .board { transform: scale(0.85); }
      .teams-bar { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .board-footer { flex-direction: column; align-items: flex-start; }
    }

    /* MODAL */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, rgba(15,23,42,0.4), rgba(0,0,0,0.95));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      backdrop-filter: blur(4px);
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal-card {
      width: min(820px, 95%);
      border-radius: 22px;
      border: 2px solid #ffffff;
      background: linear-gradient(to top, #4c1d95, #8b5cf6);
      padding: 24px 26px 24px;
      box-shadow: 0 28px 70px rgba(0,0,0,1);
      text-align: center;
      color: #f9fafb;
      position: relative;
    }

    .modal-header-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      font-size: 0.8rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .modal-body {
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .question-text {
      font-size: clamp(1.25rem, 1rem + 0.9vw, 1.7rem);
      line-height: 1.4;
    }

    .modal-media {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    .modal-media img {
      max-width: 100%;
      max-height: 260px;
      border-radius: 14px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
    }

    .modal-media audio {
      width: 100%;
      max-width: 360px;
      margin-top: 4px;
    }

    .modal-turn-pill {
      margin-top: 18px;
      border-radius: 999px;
      background: rgba(15,23,42,0.25);
      padding: 8px 16px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.82rem;
    }

    .modal-turn-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(15,23,42,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .modal-status-text {
      margin-top: 12px;
      font-size: 1.2rem;
      font-weight: 800;
    }

    .modal-status-correct {
      color: #bbf7d0;
      text-shadow: 0 0 16px rgba(34,197,94,0.9);
    }

    .modal-status-wrong {
      color: #fecaca;
      text-shadow: 0 0 16px rgba(248,113,113,0.9);
    }

    .modal-status-buzz {
      color: #fed7aa;
      text-shadow: 0 0 16px rgba(251,191,36,0.9);
    }

    .answer-text {
      margin-top: 10px;
      font-size: 1rem;
      font-weight: 700;
      color: #fef9c3;
      text-shadow: 0 0 14px rgba(254,240,138,0.95);
      display: none;
    }

    .answer-text.visible {
      display: block;
    }

    .modal-footer-row {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 0.8rem;
      color: rgba(15,23,42,0.9);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- HEADER -->
  <header class="top-header">
    <div class="logo-centered">
      <div class="logo-badge">
        <span class="logo-main">QUIZ</span>
        <span class="logo-question">?!</span>
      </div>
    </div>
    <div class="turn-overlay">
      <div class="turn-player">
        <div class="turn-avatar" id="turnAvatarHeader">T1</div>
        <span class="turn-label" id="turnTeamName">Team 1 ist dran</span>
      </div>
    </div>
    <div class="phase-badge" id="phaseBadge">Lobby – warte auf Start</div>
  </header>

  <!-- BOARD -->
  <main class="board-wrapper">
    <section class="board-inner">
      <div id="board" class="board"></div>
    </section>

    <div class="board-footer">
      <div class="hint">
        Kategorien, Fragen & Medien in <code>gameData.json</code> bearbeiten.
      </div>
      <div class="footer-controls">
        <button type="button" id="btnLobby">Lobby</button>
        <button type="button" id="btnPlay" class="primary">Spiel starten</button>
        <button type="button" id="resetBoardBtn" class="danger">Reset</button>
        <button type="button" id="openControllerBtn" class="primary">Controller</button>
        <button type="button" id="openLobbyBtn">Lobby-Ansicht</button>
      </div>
    </div>

    <section class="teams-bar" id="teamsBar"></section>
  </main>
</div>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-header-row">
      <div id="modalHeaderCategory">Kategorie</div>
      <!-- Punkte oben ausgeblendet – nur Kategorie -->
    </div>

    <div class="modal-body">
      <div id="modalQuestion" class="question-text"></div>

      <div class="modal-media" id="modalMedia" style="display:none;">
        <img id="modalImage" alt="" style="display:none;">
        <audio id="modalAudio" controls style="display:none;"></audio>
      </div>

      <div class="modal-turn-pill">
        <div class="modal-turn-avatar" id="modalTurnAvatar">T1</div>
        <div id="modalTurnText">Team 1 ist dran</div>
      </div>

      <div id="modalStatus" class="modal-status-text"></div>
      <div id="modalAnswer" class="answer-text"></div>
    </div>

    <div class="modal-footer-row">
      <span>Die Antwort wird nur gezeigt, wenn im Controller „Antwort anzeigen“ gedrückt wird.</span>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCRCG2C89X9eK_s9Lg44jc3rFRrsIua42Q",
    authDomain: "minecraftquiz-f5686.firebaseapp.com",
    databaseURL: "https://minecraftquiz-f5686-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "minecraftquiz-f5686",
    storageBucket: "minecraftquiz-f5686.firebasestorage.app",
    messagingSenderId: "278820007596",
    appId: "1:278820007596:web:67ab6be9e47be45a04f909"
  };

  const GAME_ID = "quiz-1";

  let gameData = null;
  let NUM_TEAMS = 0;

  let currentState = null;
  let gameRef = null;
  let playersRef = null;
  let currentPlayers = {};
  window.currentPlayers = currentPlayers;

  const boardEl = document.getElementById("board");
  const teamsBar = document.getElementById("teamsBar");
  const phaseBadge = document.getElementById("phaseBadge");
  const turnTeamName = document.getElementById("turnTeamName");
  const turnAvatarHeader = document.getElementById("turnAvatarHeader");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalHeaderCategory = document.getElementById("modalHeaderCategory");
  const modalQuestion = document.getElementById("modalQuestion");
  const modalMedia = document.getElementById("modalMedia");
  const modalImage = document.getElementById("modalImage");
  const modalAudio = document.getElementById("modalAudio");
  const modalTurnAvatar = document.getElementById("modalTurnAvatar");
  const modalTurnText = document.getElementById("modalTurnText");
  const modalStatus = document.getElementById("modalStatus");
  const modalAnswer = document.getElementById("modalAnswer");

  const resetBoardBtn = document.getElementById("resetBoardBtn");
  const openControllerBtn = document.getElementById("openControllerBtn");
  const openLobbyBtn = document.getElementById("openLobbyBtn");
  const btnPlay = document.getElementById("btnPlay");
  const btnLobby = document.getElementById("btnLobby");

  const pillMap = new Map();

  function getInitialState() {
    return {
      gamePhase: "lobby",
      currentTeamIndex: 0,
      scores: Array(NUM_TEAMS).fill(0),
      used: {},
      currentQuestion: null,
      buzzOpen: false,
      failedTeams: {},
      activeAnswerTeamIndex: null,
      questionResult: "none",
      showAnswer: false
    };
  }

  function renderBoardStructure() {
    boardEl.innerHTML = "";
    pillMap.clear();

    const categories = gameData.categories;
    const colCount = categories.length;

    boardEl.className = "board";
    if (colCount === 6) boardEl.classList.add("dynamic-cols-6");
    else {
      boardEl.classList.add("dynamic-cols-custom");
      boardEl.style.setProperty("--col-count", colCount);
    }

    // Kategorien
    categories.forEach(cat => {
      const cell = document.createElement("div");
      cell.className = "cell category";
      const pill = document.createElement("div");
      pill.className = "pill category-pill";
      const label = document.createElement("div");
      label.className = "category-label";
      label.textContent = cat.name;
      pill.appendChild(label);
      cell.appendChild(pill);
      boardEl.appendChild(cell);
    });

    const maxQuestions = Math.max(...categories.map(c => c.questions.length));

    for (let qIndex = 0; qIndex < maxQuestions; qIndex++) {
      categories.forEach((cat, catIndex) => {
        const q = cat.questions[qIndex];
        const cell = document.createElement("div");
        cell.className = "cell";

        if (!q) {
          cell.style.visibility = "hidden";
          boardEl.appendChild(cell);
          return;
        }

        const pill = document.createElement("div");
        pill.className = "pill value-pill";
        const label = document.createElement("div");
        label.className = "value-label";
        label.textContent = q.value;
        pill.appendChild(label);

        const key = `${catIndex}-${qIndex}`;
        pill.dataset.key = key;
        pill.addEventListener("click", () => {
          if (!currentState || currentState.used?.[key]) return;
          if (currentState.currentQuestion) return; // nicht neue öffnen, wenn noch eine läuft

          const newState = {
            currentQuestion: { catIndex, qIndex },
            buzzOpen: false,
            failedTeams: {},
            activeAnswerTeamIndex: currentState.currentTeamIndex,
            questionResult: "none",
            showAnswer: false
          };
          gameRef.update(newState);
        });

        pillMap.set(key, pill);
        cell.appendChild(pill);
        boardEl.appendChild(cell);
      });
    }
  }

  function renderTeamsStructure() {
    teamsBar.innerHTML = "";
    gameData.teams.forEach((team, index) => {
      const card = document.createElement("article");
      card.className = "team-card";
      card.dataset.teamIndex = String(index);

      const avatarsRow = document.createElement("div");
      avatarsRow.className = "team-avatars";
      avatarsRow.id = `teamAvatars_${index}`;

      const title = document.createElement("div");
      title.className = "team-title";
      title.textContent = team.label || `Team ${index+1}`;

      const names = document.createElement("div");
      names.className = "team-names";
      names.id = `teamNames_${index}`;

      const score = document.createElement("div");
      score.className = "team-score";
      score.id = `teamScore_${index}`;
      score.textContent = "0";

      const caption = document.createElement("div");
      caption.className = "team-score-caption";
      caption.textContent = "Punkte";

      card.appendChild(avatarsRow);
      card.appendChild(title);
      card.appendChild(names);
      card.appendChild(score);
      card.appendChild(caption);
      teamsBar.appendChild(card);
    });
  }

  function updateTeamsFromState(state) {
    gameData.teams.forEach((team, index) => {
      const scoreEl = document.getElementById(`teamScore_${index}`);
      if (scoreEl) {
        const score = state.scores?.[index] ?? 0;
        scoreEl.textContent = score;
      }

      const avatarsRow = document.getElementById(`teamAvatars_${index}`);
      const namesEl = document.getElementById(`teamNames_${index}`);
      if (avatarsRow) {
        avatarsRow.innerHTML = "";
        const players = Object.entries(currentPlayers)
          .filter(([id, p]) => p.teamIndex === index)
          .map(([id, p]) => p)
          .slice(0, 2);

        if (players.length > 0) {
          players.forEach(p => {
            const avatar = document.createElement("div");
            avatar.className = "team-avatar";
            if (p.avatarDataUrl) {
              avatar.style.backgroundImage = `url(${p.avatarDataUrl})`;
              avatar.textContent = "";
            } else {
              const initials = p.name.split(" ").map(x => x[0]).join("").substring(0,2).toUpperCase();
              avatar.textContent = initials;
            }
            avatarsRow.appendChild(avatar);
          });
        } else {
          const avatar = document.createElement("div");
          avatar.className = "team-avatar";
          const initials = (team.label || `Team ${index+1}`)
            .split(" ").map(x => x[0]).join("").substring(0,2).toUpperCase();
          avatar.textContent = initials;
          avatarsRow.appendChild(avatar);
        }

        if (namesEl) {
          if (players.length > 0) {
            namesEl.textContent = players.map(p => p.name).join(" · ");
          } else {
            namesEl.textContent = team.label || `Team ${index+1}`;
          }
        }
      }
    });

    const cards = teamsBar.querySelectorAll(".team-card");
    const hasQuestion = !!state.currentQuestion;
    cards.forEach((card, i) => {
      const isActive = i === state.currentTeamIndex;
      const isBuzzing =
        hasQuestion &&
        state.questionResult === "none" &&
        state.activeAnswerTeamIndex != null &&
        i === state.activeAnswerTeamIndex;

      card.classList.toggle("active", isActive);
      card.classList.toggle("buzzing", isBuzzing);
    });

    const activeTeam = gameData.teams[state.currentTeamIndex];
    if (activeTeam) {
      const players = Object.values(currentPlayers).filter(p => p.teamIndex === state.currentTeamIndex);
      const label = activeTeam.label || `Team ${state.currentTeamIndex+1}`;
      const displayName = players[0]?.name || label;
      const initials = displayName.split(" ").map(x => x[0]).join("").substring(0,2).toUpperCase();
      turnTeamName.textContent = `${label} ist dran`;
      turnAvatarHeader.textContent = initials;
      modalTurnAvatar.textContent = initials;
      modalTurnText.textContent = `${label} ist dran`;
    }

    if (state.gamePhase === "lobby") {
      phaseBadge.textContent = "Lobby – warte auf Start";
    } else {
      phaseBadge.textContent = "Spiel läuft";
    }
  }

  function updateUsedFromState(state) {
    const used = state.used || {};
    pillMap.forEach(el => el.classList.remove("used"));
    Object.keys(used).forEach(key => {
      const el = pillMap.get(key);
      if (el) el.classList.add("used");
    });
  }

  function updateModalFromState(state) {
    const cq = state.currentQuestion;
    if (!cq) {
      modalBackdrop.classList.remove("visible");
      return;
    }

    const { catIndex, qIndex } = cq;
    const cat = gameData.categories[catIndex];
    const q = cat?.questions[qIndex];
    if (!cat || !q) return;

    modalHeaderCategory.textContent = cat.name;
    modalQuestion.textContent = q.question;

    let hasMedia = false;
    if (q.image) {
      modalImage.src = q.image;
      modalImage.style.display = "block";
      hasMedia = true;
    } else {
      modalImage.style.display = "none";
    }
    if (q.audio) {
      modalAudio.src = q.audio;
      modalAudio.style.display = "block";
      hasMedia = true;
    } else {
      modalAudio.style.display = "none";
    }
    modalMedia.style.display = hasMedia ? "flex" : "none";

    const answerTeamIndex = (state.activeAnswerTeamIndex != null)
      ? state.activeAnswerTeamIndex
      : state.currentTeamIndex;
    const answerTeam = gameData.teams[answerTeamIndex];

    if (answerTeam) {
      const players = Object.values(currentPlayers).filter(p => p.teamIndex === answerTeamIndex);
      const label = answerTeam.label || `Team ${answerTeamIndex+1}`;
      const displayName = players[0]?.name || label;
      const initials = displayName.split(" ").map(x => x[0]).join("").substring(0,2).toUpperCase();
      modalTurnAvatar.textContent = initials;

      if (state.buzzOpen && state.activeAnswerTeamIndex == null) {
        modalTurnText.textContent = "Buzzer ist frei";
      } else if (state.activeAnswerTeamIndex != null) {
        modalTurnText.textContent = `${label} beantwortet`;
      } else {
        modalTurnText.textContent = `${label} ist dran`;
      }
    }

    modalStatus.textContent = "";
    modalStatus.className = "modal-status-text";

    const qr = state.questionResult || "none";
    const buzzOpen = !!state.buzzOpen;
    const activeIdx = state.activeAnswerTeamIndex;
    const buzzTeam = (activeIdx != null) ? gameData.teams[activeIdx] : null;

    if (qr === "correct" && buzzTeam) {
      modalStatus.textContent = `Richtige Antwort von ${buzzTeam.label || "dem Team"}!`;
      modalStatus.classList.add("modal-status-correct");
    } else if (qr === "wrong" && buzzTeam && buzzOpen) {
      modalStatus.textContent = `Falsche Antwort von ${buzzTeam.label || "dem Team"} – Buzzer ist frei!`;
      modalStatus.classList.add("modal-status-wrong");
    } else if (activeIdx != null && qr === "none" && buzzTeam) {
      modalStatus.textContent = `${buzzTeam.label || "Ein Team"} hat gebuzzert!`;
      modalStatus.classList.add("modal-status-buzz");
    } else if (buzzOpen) {
      modalStatus.textContent = "Buzzer ist frei!";
      modalStatus.classList.add("modal-status-buzz");
    }

    if (state.showAnswer && q.answer) {
      modalAnswer.textContent = q.answer;
      modalAnswer.classList.add("visible");
    } else {
      modalAnswer.textContent = "";
      modalAnswer.classList.remove("visible");
    }

    modalBackdrop.classList.add("visible");
  }

  resetBoardBtn.addEventListener("click", () => {
    if (!gameRef) return;
    gameRef.set(getInitialState());
  });

  openControllerBtn.addEventListener("click", () => {
    window.open("controller.html", "_blank");
  });

  openLobbyBtn.addEventListener("click", () => {
    window.open("lobby.html", "_blank");
  });

  btnPlay.addEventListener("click", () => {
    if (!gameRef || !currentState) return;
    gameRef.update({ gamePhase: "playing" });
  });

  btnLobby.addEventListener("click", () => {
    if (!gameRef || !currentState) return;
    gameRef.update({
      gamePhase: "lobby",
      currentQuestion: null,
      buzzOpen: false,
      activeAnswerTeamIndex: null,
      failedTeams: {},
      questionResult: "none",
      showAnswer: false
    });
  });

  async function init() {
    const res = await fetch("gameData.json");
    gameData = await res.json();
    NUM_TEAMS = gameData.teams.length;

    renderBoardStructure();
    renderTeamsStructure();

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    gameRef = db.ref("games/" + GAME_ID);
    playersRef = db.ref("games/" + GAME_ID + "/players");

    playersRef.on("value", snap => {
      currentPlayers = snap.val() || {};
      window.currentPlayers = currentPlayers;
      if (currentState) {
        updateTeamsFromState(currentState);
      }
    });

    gameRef.on("value", snapshot => {
      if (!snapshot.exists()) {
        gameRef.set(getInitialState());
        return;
      }
      const state = snapshot.val();
      currentState = state;
      updateTeamsFromState(state);
      updateUsedFromState(state);
      updateModalFromState(state);
    });
  }

  init();
</script>
</body>
</html>
